# SORA 2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ KudoAiBot

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ö–ª–∏–µ–Ω—Ç SORA 2 (`app/services/clients/sora_client.py`)

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º OpenAI SORA 2 API:

**–§—É–Ω–∫—Ü–∏–∏:**
- `create_sora_task()` - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ
- `generate_video_sora2_async()` - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞
- `generate_video_sora2()` - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞
- `extract_user_from_metadata()` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ user_id –∏–∑ callback

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```python
prompt: str               # –¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ
aspect_ratio: str        # "9:16" –∏–ª–∏ "16:9"
duration: int            # –î–æ 20 —Å–µ–∫—É–Ω–¥
user_id: int             # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è callback
```

**API Endpoint:**
```
POST https://api.openai.com/v1/videos/generations
```

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
1. –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ —á–µ—Ä–µ–∑ OpenAI API
2. –ü–æ–ª—É—á–∞–µ–º `task_id`
3. OpenAI –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç callback –∫–æ–≥–¥–∞ –≤–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ
4. –í–∏–¥–µ–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### 2. –ú–µ—Ö–∞–Ω–∏–∫–∞ –∏–∑ SORA 2 –±–æ—Ç–∞

–í–∑—è—Ç—ã —Å–ª–µ–¥—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã:

**Workflow (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å):**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  ‚Üì
–í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ (SORA 2)
  ‚Üì
–í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ (–ü–æ–º–æ—â–Ω–∏–∫/–†—É—á–Ω–æ–π/–ú–µ–º)
  ‚Üì
–í—ã–±–æ—Ä –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ (9:16 –∏–ª–∏ 16:9)
  ‚Üì
–í–≤–æ–¥ –ø—Ä–æ–º–ø—Ç–∞
  ‚Üì
–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è
  ‚Üì
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è)
  ‚Üì
Callback –æ—Ç OpenAI
  ‚Üì
–í–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

**–ö–Ω–æ–ø–∫–∏:**
- –í—ã–±–æ—Ä –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –ü–ï–†–ï–î –≤–≤–æ–¥–æ–º –ø—Ä–æ–º–ø—Ç–∞
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏: –°–æ–∑–¥–∞—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å / –û—Ç–º–µ–Ω–∞
- –ü–æ—Å–ª–µ –≤–∏–¥–µ–æ: –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ

**–°–æ—Å—Ç–æ—è–Ω–∏—è:**
```python
user_waiting_for_video_orientation = {}
user_video_requests = {}
user_prompt_messages = {}
user_confirmation_messages = {}
user_video_messages = {}
user_task_messages = {}  # –°–æ–æ–±—â–µ–Ω–∏—è –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏
```

### 3. –û—Ç–ª–∏—á–∏—è –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ SORA 2 –±–æ—Ç–∞

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –±–æ—Ç | KudoAiBot |
|----------|------------------|-----------|
| API | KIE.AI (proxy) | OpenAI Official |
| Endpoint | api.kie.ai | api.openai.com |
| Callback | /sora_callback | /sora_callback |
| –†–µ–∂–∏–º—ã | –¢–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π | –ü–æ–º–æ—â–Ω–∏–∫/–†—É—á–Ω–æ–π/–ú–µ–º |
| GPT –ø–æ–º–æ—â–Ω–∏–∫ | –ù–µ—Ç | –ï—Å—Ç—å |
| –°—Ç—Ä—É–∫—Ç—É—Ä–∞ | –ü–ª–æ—Å–∫–∞—è | –ú–æ–¥—É–ª—å–Ω–∞—è |

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# OpenAI API
OPENAI_API_KEY=sk-...  # –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª—é—á OpenAI –¥–ª—è SORA 2

# Webhook
PUBLIC_URL=https://your-domain.com  # –î–ª—è callback –æ—Ç OpenAI

# –†–µ–∂–∏–º
TELEGRAM_MODE=webhook  # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ webhook –¥–ª—è callback
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

```python
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∫–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
import os
print("OPENAI_API_KEY:", "‚úÖ Set" if os.getenv("OPENAI_API_KEY") else "‚ùå Missing")
```

## üì° Webhook –¥–ª—è SORA 2

–î–æ–±–∞–≤–∏—Ç—å –≤ `main.py`:

```python
async def sora2_callback(request):
    """Callback –æ—Ç OpenAI SORA 2 ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ"""
    try:
        data = await request.json()
        log.info(f"üé¨ SORA 2 callback received: {data}")
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≤–∏–¥–µ–æ
        video_id = data.get("id")
        status = data.get("status")
        metadata = data.get("metadata", {})
        user_id = extract_user_from_metadata(metadata)
        
        if status == "completed" and user_id:
            # –ü–æ–ª—É—á–∞–µ–º URL –≤–∏–¥–µ–æ
            video_url = data.get("output", {}).get("url")
            
            if video_url:
                # –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                user = await users.get_user(user_id)
                user_language = user.get('language', 'ru') if user else 'ru'
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                try:
                    await bot.send_video(
                        user_id,
                        video=video_url,
                        caption="‚ú® –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ! –ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞–ø—Ä–æ—Å –≤ —á–∞—Ç.",
                        reply_markup=build_video_result_menu(user_language),
                        parse_mode="HTML"
                    )
                    log.info(f"‚úÖ SORA 2 video sent to user {user_id}")
                    
                except Exception as e:
                    log.error(f"‚ùå Failed to send SORA 2 video to user {user_id}: {e}")
                    # Fallback - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É
                    await bot.send_message(
                        user_id,
                        f"‚ú® –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ!\nüìπ <a href='{video_url}'>–°–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ</a>",
                        parse_mode="HTML"
                    )
        
        elif status == "failed" and user_id:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–æ–Ω–µ—Ç–∫–∏
            error_message = data.get("error", {}).get("message", "Unknown error")
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–æ–Ω–µ—Ç–∫–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å
            await billing.refund_coins_for_feature(user_id, "video_8s_mute")
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await bot.send_message(
                user_id,
                f"‚ùå <b>–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ</b>\n\n"
                f"–ü—Ä–∏—á–∏–Ω–∞: {error_message}\n\n"
                f"üí∞ –ú–æ–Ω–µ—Ç–∫–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –Ω–∞ –±–∞–ª–∞–Ω—Å",
                parse_mode="HTML"
            )
            log.info(f"‚úÖ SORA 2 error handled for user {user_id}")
        
        return web.Response(text="OK")
        
    except Exception as e:
        log.error(f"‚ùå Error in SORA 2 callback: {e}")
        return web.Response(text="Error", status=500)

# –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç
app.router.add_post('/sora_callback', sora2_callback)
```

## üéØ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:

1. `/start`
2. üé¨ –í–ò–î–ï–û
3. üåü SORA 2
4. –í—ã–±—Ä–∞—Ç—å —Ä–µ–∂–∏–º:
   - ü§ñ –° –ø–æ–º–æ—â–Ω–∏–∫–æ–º (GPT —É–ª—É—á—à–∞–µ—Ç –ø—Ä–æ–º–ø—Ç)
   - ‚úã –í—Ä—É—á–Ω—É—é (—Å–≤–æ–π –ø—Ä–æ–º–ø—Ç)
   - üòÑ –ú–µ–º (–±—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è)
5. –í—ã–±—Ä–∞—Ç—å –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é: üì± 9:16 –∏–ª–∏ üñ•Ô∏è 16:9
6. –í–≤–µ—Å—Ç–∏ –æ–ø–∏—Å–∞–Ω–∏–µ
7. –ü–æ–¥–æ–∂–¥–∞—Ç—å (OpenAI –æ—Ç–ø—Ä–∞–≤–∏—Ç callback)
8. –ü–æ–ª—É—á–∏—Ç—å –≤–∏–¥–µ–æ!

### –ü—Ä–∏–º–µ—Ä (–†–µ–∂–∏–º –ø–æ–º–æ—â–Ω–∏–∫–∞):

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "—Å–æ–±–∞–∫–∞ –±–µ–∂–∏—Ç –ø–æ –ø–∞—Ä–∫—É"
  ‚Üì
GPT —É–ª—É—á—à–∞–µ—Ç:
"A golden retriever dog running joyfully through a sunny park..."
  ‚Üì
SORA 2 –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–∏–¥–µ–æ
  ‚Üì
Callback –æ—Ç OpenAI
  ‚Üì
–í–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
grep "SORA 2 task created" logs/bot.log

# –ü—Ä–æ–≤–µ—Ä–∫–∞ callback
grep "SORA 2 callback received" logs/bot.log

# –û—à–∏–±–∫–∏
grep "SORA 2 API error" logs/bot.log
```

### –°—Ç–∞—Ç—É—Å—ã

- `success` - –∑–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞
- `immediate` - –≤–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ —Å—Ä–∞–∑—É
- `demo_mode` - API –∫–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- `insufficient_credits` - –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ OpenAI
- `rate_limit` - –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
- `network_error` - —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞

## üí° –û—Ç–ª–∏—á–∏—è SORA 2 –æ—Ç VEO 3

| –ü–∞—Ä–∞–º–µ—Ç—Ä | SORA 2 (OpenAI) | VEO 3 (Google) |
|----------|-----------------|----------------|
| –ü—Ä–æ–≤–∞–π–¥–µ—Ä | OpenAI | Google Cloud |
| –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –î–æ 20 —Å–µ–∫—É–Ω–¥ | 6-8 —Å–µ–∫—É–Ω–¥ |
| –ê—É–¥–∏–æ | –í—Å–µ–≥–¥–∞ | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ |
| –ö–∞—á–µ—Å—Ç–≤–æ | 1080p | 720p/1080p |
| –¶–µ–Ω–∞ | –ü–æ –∫—Ä–µ–¥–∏—Ç–∞–º OpenAI | –ü–æ GCP —Ç–∞—Ä–∏—Ñ–∞–º |
| –ì–µ–Ω–µ—Ä–∞—Ü–∏—è | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è (callback) | –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è (polling) |
| Watermark | –ù–µ—Ç | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ |

## üö® –í–∞–∂–Ω–æ

1. **OPENAI_API_KEY** - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–µ–Ω –¥–ª—è SORA 2
2. **PUBLIC_URL** - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è webhook callback
3. **TELEGRAM_MODE=webhook** - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, polling –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç callback
4. **–ú–æ–Ω–µ—Ç–∫–∏** - —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å—Ä–∞–∑—É, –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–µ

## üìù TODO

- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –≤–∏–¥–µ–æ (1:1, 4:3)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä –∫–∞—á–µ—Å—Ç–≤–∞ (720p, 1080p)
- [ ] –î–æ–±–∞–≤–∏—Ç—å progress updates (–µ—Å–ª–∏ OpenAI –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä –≤–∏–¥–µ–æ –¥–ª—è Telegram

---

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üöÄ

SORA 2 –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π OpenAI API.

