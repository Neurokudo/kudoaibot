#!/bin/bash
# –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤..."

# –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
REGISTERED=$(grep -o "dp.callback_query.register(callback_[a-z_]*" app/handlers/callbacks.py | sed 's/dp.callback_query.register(//' | sort -u)

# –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏  
DEFINED=$(grep -o "^async def callback_[a-z_0-9]*" app/handlers/callbacks.py | sed 's/^async def //' | sort -u)

echo "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ: $(echo "$REGISTERED" | wc -l)"
echo "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–æ: $(echo "$DEFINED" | wc -l)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è
MISSING=$(comm -23 <(echo "$REGISTERED") <(echo "$DEFINED"))
UNUSED=$(comm -13 <(echo "$REGISTERED") <(echo "$DEFINED"))

if [ -n "$MISSING" ]; then
    echo "‚ùå –û–®–ò–ë–ö–ê: –§—É–Ω–∫—Ü–∏–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã, –Ω–æ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã:"
    echo "$MISSING"
    exit 1
fi

if [ -n "$UNUSED" ]; then
    echo "‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –§—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã, –Ω–æ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã:"
    echo "$UNUSED"
fi

echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!"
