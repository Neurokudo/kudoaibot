# ๐ฐ ะกะธััะตะผะฐ ะพะฟะปะฐัั KudoAiBot

## ๐ฏ ะะฑะทะพั

KudoAiBot ะธัะฟะพะปัะทัะตั **ะดะฒััััะพะฒะฝะตะฒัั ัะธััะตะผั ะผะพะฝะตัะธะทะฐัะธะธ**:

1. **๐ ะะพะดะฟะธัะบะธ** (ัะฐัะธัั ะฝะฐ 30 ะดะฝะตะน) - ะดะฐัั ะผะพะฝะตัะบะธ ััะฐะทั
2. **๐ฐ ะะพะฟะพะปะฝะตะฝะธะต ะผะพะฝะตัะพะบ** (ัะฐะทะพะฒัะต ะฟะพะบัะฟะบะธ) - ะดะพะบัะฟะบะฐ ะฟะพ ะผะตัะต ะฝะตะพะฑัะพะดะธะผะพััะธ

## ๐๏ธ ะััะธัะตะบัััะฐ

```
ะะพะปัะทะพะฒะฐัะตะปั
    โ
ะัะพัะธะปั โ ะัะฑะพั (ะะพะดะฟะธัะบะฐ ะธะปะธ ะะพะฝะตัะบะธ)
    โ
YooKassa (ะพะฟะปะฐัะฐ)
    โ
Webhook (ะฟะพะดัะฒะตัะถะดะตะฝะธะต)
    โ
ะะฐะทะฐ ะดะฐะฝะฝัั (ะฝะฐัะธัะปะตะฝะธะต)
    โ
ะฃะฒะตะดะพะผะปะตะฝะธะต ะฟะพะปัะทะพะฒะฐัะตะปั
```

## ๐ ะขะฐัะธัั (ะฟะพะดะฟะธัะบะธ ะฝะฐ 30 ะดะฝะตะน)

```python
# app/config/pricing.py

TARIFFS = {
    "lite": {
        "title": "โจ ะะฐะนั",
        "price_rub": 1990,
        "coins": 250,
        "duration_days": 30
    },
    "standard": {
        "title": "โญ ะกัะฐะฝะดะฐัั",
        "price_rub": 2990,
        "coins": 400,
        "duration_days": 30
    },
    "pro": {
        "title": "๐ ะัะพ",
        "price_rub": 4990,
        "coins": 750,
        "duration_days": 30
    }
}
```

### ะงัะพ ะดะฐัั ะฟะพะดะฟะธัะบะฐ:

- โ ะะพะฝะตัะบะธ ััะฐะทั ะฝะฐ ะฑะฐะปะฐะฝั
- โ ะะพะฝะตัะบะธ ะฝะต ัะณะพัะฐัั ะฟะพัะปะต ะพะบะพะฝัะฐะฝะธั ะฟะพะดะฟะธัะบะธ
- โ ะะพะถะฝะพ ะฝะฐะบะฐะฟะปะธะฒะฐัั ะผะพะฝะตัะบะธ
- โ ะะฒัะพะผะฐัะธัะตัะบะพะต ะฟัะพะดะปะตะฝะธะต (ะพะฟัะธะพะฝะฐะปัะฝะพ)

## ๐ฐ ะะฐะบะตัั ะฟะพะฟะพะปะฝะตะฝะธั (ัะฐะทะพะฒะฐั ะฟะพะบัะฟะบะฐ)

```python
# app/config/pricing.py

TOPUP_PACKS = [
    TopupPack(coins=50,  price_rub=990,  bonus_coins=0),   # ะะฐะทะพะฒัะน
    TopupPack(coins=120, price_rub=1990, bonus_coins=10),  # +10 ะฑะพะฝัั
    TopupPack(coins=250, price_rub=3990, bonus_coins=30),  # +30 ะฑะพะฝัั
    TopupPack(coins=500, price_rub=7490, bonus_coins=75),  # +75 ะฑะพะฝัั
]
```

### ะัะตะธะผััะตััะฒะฐ ะฟะพะฟะพะปะฝะตะฝะธั:

- ๐ฐ ะะพะบัะฟะฐะตัะต ัะพะปัะบะพ ะบะพะณะดะฐ ะฝัะถะฝะพ
- ๐ ะะพะฝััะฝัะต ะผะพะฝะตัะบะธ (ะพั 10 ะดะพ 75)
- โพ๏ธ ะะพะฝะตัะบะธ ะฝะต ัะณะพัะฐัั ะฝะธะบะพะณะดะฐ
- ๐ ะะฐะฑะพัะฐะตั ะฑะตะท ะฐะบัะธะฒะฝะพะน ะฟะพะดะฟะธัะบะธ

## ๐ ะกัะพะธะผะพััั ััะฝะบัะธะน (ะฒ ะผะพะฝะตัะบะฐั)

### ๐ฌ ะะธะดะตะพ:

| ะคัะฝะบัะธั | ะะพะฝะตัะบะธ | ะะฟะธัะฐะฝะธะต |
|---------|---------|----------|
| VEO 3 (6 ัะตะบ, ะฑะตะท ะทะฒัะบะฐ) | 14 | ะะพัะพัะบะพะต ะฒะธะดะตะพ |
| VEO 3 (8 ัะตะบ, ะฑะตะท ะทะฒัะบะฐ) | 18 | ะกัะฐะฝะดะฐััะฝะพะต ะฒะธะดะตะพ |
| VEO 3 (8 ัะตะบ, ัะพ ะทะฒัะบะพะผ) | 26 | ะะธะดะตะพ ั ะฐัะดะธะพ |
| SORA 2 (5 ัะตะบ) | 22 | OpenAI SORA 2 |

### ๐ธ ะคะพัะพ (ัะบะพัะพ):

| ะคัะฝะบัะธั | ะะพะฝะตัะบะธ | ะะฟะธัะฐะฝะธะต |
|---------|---------|----------|
| ะะฐะทะพะฒัะต ะพะฟะตัะฐัะธะธ | 1 | ะัะพัััะต ะธะทะผะตะฝะตะฝะธั |
| ะฃะฒะตะปะธัะตะฝะธะต ะบะฐัะตััะฒะฐ | 2 | Upscale |
| ะฃะปัััะตะฝะธะต ัะพัะพ | 3 | AI enhancement |

### ๐ ะัะธะผะตัะพัะฝะฐั:

| ะคัะฝะบัะธั | ะะพะฝะตัะบะธ | ะะฟะธัะฐะฝะธะต |
|---------|---------|----------|
| 1 ะพะฑัะฐะท | 3 | ะะดะฝะฐ ะฟัะธะผะตัะบะฐ |
| 3 ะพะฑัะฐะทะฐ | 8 | ะขัะธ ะฒะฐัะธะฐะฝัะฐ |

## ๐ Workflow ะฟะพะบัะฟะบะธ

### ะะพะบัะฟะบะฐ ะฟะพะดะฟะธัะบะธ:

```
1. ะะพะปัะทะพะฒะฐัะตะปั: /start โ ๐ค ะัะพัะธะปั
   โ
2. ะะพั ะฟะพะบะฐะทัะฒะฐะตั ัะฐัะธัั:
   โจ ะะฐะนั โ 1990 โฝ (250 ะผะพะฝะตั)
   โญ ะกัะฐะฝะดะฐัั โ 2990 โฝ (400 ะผะพะฝะตั)
   ๐ ะัะพ โ 4990 โฝ (750 ะผะพะฝะตั)
   ๐ฐ ะัะฟะธัั ะผะพะฝะตัะบะธ
   โ
3. ะะพะปัะทะพะฒะฐัะตะปั ะฒัะฑะธัะฐะตั ัะฐัะธั
   โ
4. ะะพั ัะพะทะดะฐัั ะฟะปะฐััะถ ะฒ YooKassa
   โ
5. ะะพะปัะทะพะฒะฐัะตะปั ะพะฟะปะฐัะธะฒะฐะตั (ะฑะฐะฝะบะพะฒัะบะฐั ะบะฐััะฐ)
   โ
6. YooKassa ะพัะฟัะฐะฒะปัะตั webhook โ /yookassa_webhook
   โ
7. ะะพั ะฝะฐัะธัะปัะตั ะผะพะฝะตัะบะธ ะฝะฐ ะฑะฐะปะฐะฝั
   โ
8. ะฃะฒะตะดะพะผะปะตะฝะธะต: "โ ะะพะดะฟะธัะบะฐ ะฐะบัะธะฒะธัะพะฒะฐะฝะฐ! +250 ะผะพะฝะตัะพะบ"
```

### ะะพะบัะฟะบะฐ ะผะพะฝะตัะพะบ:

```
1. ะะพะปัะทะพะฒะฐัะตะปั: ะัะพัะธะปั โ ๐ฐ ะัะฟะธัั ะผะพะฝะตัะบะธ
   โ
2. ะะพั ะฟะพะบะฐะทัะฒะฐะตั ะฟะฐะบะตัั:
   ๐ฐ 50 ะผะพะฝะตั โ 990 โฝ
   ๐ฐ 130 ะผะพะฝะตั (120+10 ะฑะพะฝัั) โ 1990 โฝ
   ๐ฐ 280 ะผะพะฝะตั (250+30 ะฑะพะฝัั) โ 3990 โฝ
   ๐ฐ 575 ะผะพะฝะตั (500+75 ะฑะพะฝัั) โ 7490 โฝ
   โ
3. ะะพะปัะทะพะฒะฐัะตะปั ะฒัะฑะธัะฐะตั ะฟะฐะบะตั
   โ
4. ะะฟะปะฐัะฐ ัะตัะตะท YooKassa
   โ
5. Webhook ะพะฑัะฐะฑะฐััะฒะฐะตั ะฟะปะฐััะถ
   โ
6. ะะพะฝะตัะบะธ ะฝะฐัะธัะปะตะฝั!
```

## ๐ง ะขะตัะฝะธัะตัะบะธะต ะดะตัะฐะปะธ

### YooKassa ะธะฝัะตะณัะฐัะธั

```python
# app/services/yookassa_service.py

def create_subscription_payment(user_id, tariff_name, price_rub):
    """ะกะพะทะดะฐัั ะฟะปะฐััะถ ะดะปั ะฟะพะดะฟะธัะบะธ"""
    payment = Payment.create({
        "amount": {"value": f"{price_rub}.00", "currency": "RUB"},
        "confirmation": {"type": "redirect"},
        "metadata": {
            "user_id": str(user_id),
            "payment_type": "subscription",
            "plan_or_coins": tariff_name
        }
    })
    return payment

def create_topup_payment(user_id, coins, price_rub):
    """ะกะพะทะดะฐัั ะฟะปะฐััะถ ะดะปั ะฟะพะฟะพะปะฝะตะฝะธั"""
    payment = Payment.create({
        "amount": {"value": f"{price_rub}.00", "currency": "RUB"},
        "metadata": {
            "user_id": str(user_id),
            "payment_type": "topup",
            "plan_or_coins": str(coins)
        }
    })
    return payment
```

### Webhook ะพะฑัะฐะฑะพััะธะบ

```python
# app/webhooks/yookassa.py

async def yookassa_webhook(request):
    """ะะฑัะฐะฑะพัะบะฐ webhook ะพั YooKassa"""
    data = await request.json()
    
    if data['event'] == 'payment.succeeded':
        metadata = data['object']['metadata']
        user_id = int(metadata['user_id'])
        payment_type = metadata['payment_type']
        
        if payment_type == 'subscription':
            # ะะบัะธะฒะธัะพะฒะฐัั ะฟะพะดะฟะธัะบั
            await billing.process_subscription_payment(...)
            
        elif payment_type == 'topup':
            # ะะพะฟะพะปะฝะธัั ะผะพะฝะตัะบะธ
            await billing.process_topup_payment(...)
```

## ๐ณ ะะฝัะตะณัะฐัะธั ั YooKassa

### ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั:

```bash
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key
PUBLIC_URL=https://your-domain.com  # ะะปั webhook
```

### ะะฐัััะพะนะบะฐ ะฒ YooKassa:

1. ะะฐัะตะณะธัััะธััะนัะตัั ะฝะฐ https://yookassa.ru/
2. ะะพะปััะธัะต `SHOP_ID` ะธ `SECRET_KEY`
3. ะะฐัััะพะนัะต webhook URL: `https://your-domain.com/yookassa_webhook`
4. ะะพะฑะฐะฒััะต ะฒ Railway ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

## ๐จ UI ะดะปั ะฟะพะบัะฟะบะธ

### ะัะพัะธะปั ะฟะพะปัะทะพะฒะฐัะตะปั:

```
๐ค ะัะพัะธะปั

ะะผั: ะะฝัะพะฝ
๐ฐ ะะฐะปะฐะฝั: 150 ะผะพะฝะตัะพะบ
๐ ะขะฐัะธั: โญ ะกัะฐะฝะดะฐัั
๐ ะะตะณะธัััะฐัะธั: 20.10.2025

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ โจ ะะฐะนั โ 1990 โฝ              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โญ ะกัะฐะฝะดะฐัั โ 2990 โฝ          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ ะัะพ โ 4990 โฝ               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ฐ ะัะฟะธัั ะผะพะฝะตัะบะธ             โ โ ะะพะฒะฐั ะบะฝะพะฟะบะฐ!
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ ะะปะฐะฒะฝะพะต ะผะตะฝั               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะตะฝั ะฟะพะฟะพะปะฝะตะฝะธั:

```
๐ฐ ะัะฟะธัั ะผะพะฝะตัะบะธ

โ ะะฐะบะตัั ะฟะพะฟะพะปะฝะตะฝะธั:

โข 50 ะผะพะฝะตั โ 990 โฝ
โข 130 ะผะพะฝะตั (120+10 ะฑะพะฝัั) โ 1 990 โฝ
โข 280 ะผะพะฝะตั (250+30 ะฑะพะฝัั) โ 3 990 โฝ
โข 575 ะผะพะฝะตั (500+75 ะฑะพะฝัั) โ 7 490 โฝ

๐ก ะะพะฝะตัะบะธ ะฝะต ัะณะพัะฐัั ะธ ะดะพัััะฟะฝั ะฑะตะท ะฟะพะดะฟะธัะบะธ!

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ฐ 50 ะผะพะฝะตั โ 990 โฝ           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ฐ 130 ะผะพะฝะตั (120+10) โ 1990โฝโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ฐ 280 ะผะพะฝะตั (250+30) โ 3990โฝโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ฐ 575 ะผะพะฝะตั (500+75) โ 7490โฝโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โฌ๏ธ ะ ัะฐัะธัะฐะผ                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ ะะปะฐะฒะฝะพะต ะผะตะฝั               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ก ะัะธะผะตัั ัะฐััััะพะฒ

### ะขะฐัะธั "ะกัะฐะฝะดะฐัั" (400 ะผะพะฝะตัะพะบ):

```
400 ะผะพะฝะตัะพะบ = 2990 โฝ

ะงัะพ ะผะพะถะฝะพ ัะดะตะปะฐัั:
โข 15 ะฒะธะดะตะพ VEO 3 (8 ัะตะบ, ัะพ ะทะฒัะบะพะผ) ะฟะพ 26 ะผะพะฝะตั
โข ะธะปะธ 22 ะฒะธะดะตะพ VEO 3 (8 ัะตะบ, ะฑะตะท ะทะฒัะบะฐ) ะฟะพ 18 ะผะพะฝะตั
โข ะธะปะธ 133 ะฒะธัััะฐะปัะฝัั ะฟัะธะผะตัะพะบ ะฟะพ 3 ะผะพะฝะตัะบะธ
โข ะธะปะธ 400 ะฑะฐะทะพะฒัั ะพะฟะตัะฐัะธะน ั ัะพัะพ ะฟะพ 1 ะผะพะฝะตัะบะต

ะฆะตะฝะฐ ะทะฐ ะฒะธะดะตะพ: ~199 โฝ (2990 / 15)
```

### ะะฐะบะตั 280 ะผะพะฝะตั (250+30 ะฑะพะฝัั):

```
280 ะผะพะฝะตัะพะบ = 3990 โฝ

โข 10 ะฒะธะดะตะพ VEO 3 (8 ัะตะบ, ัะพ ะทะฒัะบะพะผ)
โข ะธะปะธ 15 ะฒะธะดะตะพ VEO 3 (8 ัะตะบ, ะฑะตะท ะทะฒัะบะฐ)
โข ะธะปะธ 93 ะฒะธัััะฐะปัะฝัั ะฟัะธะผะตัะบะธ

ะฆะตะฝะฐ ะทะฐ ะฒะธะดะตะพ: ~399 โฝ (3990 / 10)
```

## ๐ ะะตะทะพะฟะฐัะฝะพััั

### ะัะพะฒะตัะบะฐ ะดะพัััะฟะฐ:

```python
# ะะตัะตะด ะณะตะฝะตัะฐัะธะตะน ะฒะธะดะตะพ
access = await billing.check_access(user_id, "video_8s_mute")

if access['access']:
    # ะะพะถะฝะพ ะณะตะฝะตัะธัะพะฒะฐัั
    await generate_video(...)
else:
    # ะะพะบะฐะทะฐัั ัะพะพะฑัะตะฝะธะต ะพ ะฝะตะดะพััะฐัะบะต ะผะพะฝะตัะพะบ
    await show_payment_options(...)
```

### ะกะฟะธัะฐะฝะธะต ะผะพะฝะตัะพะบ:

```python
# ะกะฟะธััะฒะฐะตะผ ัะพะปัะบะพ ะฟะพัะปะต ััะฟะตัะฝะพะณะพ ะฝะฐัะฐะปะฐ ะณะตะฝะตัะฐัะธะธ
result = await billing.deduct_coins_for_feature(user_id, "video_8s_mute")

if result['success']:
    # ะะพะฝะตัะบะธ ัะฟะธัะฐะฝั
    new_balance = result['new_balance']
```

### ะะพะทะฒัะฐั ะฟัะธ ะพัะธะฑะบะต:

```python
# ะัะปะธ ะณะตะฝะตัะฐัะธั ะฝะต ัะดะฐะปะฐัั
if generation_failed:
    # ะะพะทะฒัะฐัะฐะตะผ ะผะพะฝะตัะบะธ ะพะฑัะฐัะฝะพ
    await billing.refund_coins_for_feature(user_id, "video_8s_mute")
```

## ๐ฑ ะะพะปัะทะพะฒะฐัะตะปััะบะธะน ะพะฟัั

### ะกัะตะฝะฐัะธะน 1: ะะพะบัะฟะบะฐ ะฟะพะดะฟะธัะบะธ

```
ะะพะปัะทะพะฒะฐัะตะปั: ะฅะพัั ะณะตะฝะตัะธัะพะฒะฐัั ะฒะธะดะตะพ
    โ
ะะพั: ะฃ ะฒะฐั 0 ะผะพะฝะตัะพะบ. ะัะฟะธัะต ะฟะพะดะฟะธัะบั!
    โ
ะะพะปัะทะพะฒะฐัะตะปั: ะัะฑะธัะฐะตั "โญ ะกัะฐะฝะดะฐัั โ 2990 โฝ"
    โ
ะะพั: ะกะพะทะดะฐัั ัััะปะบั ะฝะฐ ะพะฟะปะฐัั YooKassa
    โ
ะะพะปัะทะพะฒะฐัะตะปั: ะะฟะปะฐัะธะฒะฐะตั ะบะฐััะพะน (Visa/MasterCard/ะะธั)
    โ
YooKassa: ะัะฟัะฐะฒะปัะตั webhook ะฑะพัั
    โ
ะะพั: ะะฐัะธัะปัะตั 400 ะผะพะฝะตัะพะบ
    โ
ะฃะฒะตะดะพะผะปะตะฝะธะต: "โ ะะพะดะฟะธัะบะฐ ะฐะบัะธะฒะธัะพะฒะฐะฝะฐ! +400 ะผะพะฝะตัะพะบ"
    โ
ะะพะปัะทะพะฒะฐัะตะปั: ะะพะถะตั ะณะตะฝะตัะธัะพะฒะฐัั ะฒะธะดะตะพ!
```

### ะกัะตะฝะฐัะธะน 2: ะะพะบัะฟะบะฐ ะผะพะฝะตัะพะบ

```
ะะพะปัะทะพะฒะฐัะตะปั: ะััะฐะปะพัั 10 ะผะพะฝะตัะพะบ, ัะพัั ะตัั
    โ
ะะพั: ะัะพัะธะปั โ ๐ฐ ะัะฟะธัั ะผะพะฝะตัะบะธ
    โ
ะะพะบะฐะทัะฒะฐะตั ะฟะฐะบะตัั ั ะฑะพะฝััะฐะผะธ
    โ
ะะพะปัะทะพะฒะฐัะตะปั: ะัะฑะธัะฐะตั "280 ะผะพะฝะตั (250+30 ะฑะพะฝัั) โ 3990 โฝ"
    โ
ะะฟะปะฐัะฐ โ Webhook โ ะะฐัะธัะปะตะฝะธะต
    โ
ะฃะฒะตะดะพะผะปะตะฝะธะต: "โ ะะพะฟะพะปะฝะตะฝะพ: 250 + 30 ะฑะพะฝัั = 280 ะผะพะฝะตั!"
    โ
ะะฐะปะฐะฝั: 10 + 280 = 290 ะผะพะฝะตัะพะบ
```

## ๐ ะะพะฝััะฝะฐั ัะธััะตะผะฐ

ะงะตะผ ะฑะพะปััะต ะฟะพะบัะฟะฐะตัะต ะผะพะฝะตัะพะบ - ัะตะผ ะฑะพะปััะต ะฑะพะฝัั!

```
50 ะผะพะฝะตั   โ 0 ะฑะพะฝััะพะฒ   (990 โฝ)
120 ะผะพะฝะตั  โ +10 ะฑะพะฝััะพะฒ (1990 โฝ)  ๐
250 ะผะพะฝะตั  โ +30 ะฑะพะฝััะพะฒ (3990 โฝ)  ๐๐
500 ะผะพะฝะตั  โ +75 ะฑะพะฝััะพะฒ (7490 โฝ)  ๐๐๐
```

## ๐ ะะฐะทะฐ ะดะฐะฝะฝัั

### ะขะฐะฑะปะธัะฐ users:

```sql
users (
    user_id BIGINT,
    username TEXT,
    first_name TEXT,
    videos_left INT,        -- ะะฐะปะฐะฝั ะผะพะฝะตัะพะบ
    plan_name TEXT,         -- ะขะตะบััะธะน ัะฐัะธั
    created_at TIMESTAMP
)
```

### ะขะฐะฑะปะธัะฐ subscriptions:

```sql
subscriptions (
    user_id BIGINT,
    tariff_name TEXT,
    coins INT,
    expires_at TIMESTAMP,
    is_active BOOLEAN,
    created_at TIMESTAMP
)
```

### ะขะฐะฑะปะธัะฐ transactions:

```sql
transactions (
    user_id BIGINT,
    amount INT,              -- ะะพะฝะตัะบะธ (+/-)
    transaction_type TEXT,   -- spend, topup, subscription
    description TEXT,
    balance_after INT,
    created_at TIMESTAMP
)
```

## ๐ป ะะพะด ะธะฝัะตะณัะฐัะธะธ

### ะกะพะทะดะฐะฝะธะต ะฟะปะฐัะตะถะฐ (ะฟะพะดะฟะธัะบะฐ):

```python
# app/handlers/payments.py

@dp.callback_query(F.data.startswith("buy_tariff_"))
async def handle_buy_tariff(callback):
    tariff_name = callback.data.replace("buy_tariff_", "")
    
    # ะกะพะทะดะฐัะผ ะฟะปะฐััะถ
    payment = create_subscription_payment(
        user_id=user_id,
        tariff_name=tariff_name,
        price_rub=tariff.price_rub
    )
    
    # ะะพะบะฐะทัะฒะฐะตะผ ัััะปะบั ะฝะฐ ะพะฟะปะฐัั
    await callback.message.edit_text(
        f"๐ณ ะะฟะปะฐัะธัั: {payment['confirmation_url']}"
    )
```

### ะกะพะทะดะฐะฝะธะต ะฟะปะฐัะตะถะฐ (ะผะพะฝะตัะบะธ):

```python
@dp.callback_query(F.data.startswith("buy_topup_"))
async def handle_buy_topup(callback):
    coins = int(callback.data.replace("buy_topup_", ""))
    
    pack = get_topup_pack(coins)
    
    payment = create_topup_payment(
        user_id=user_id,
        coins=pack.coins,
        price_rub=pack.price_rub
    )
    
    await show_payment_link(payment)
```

### ะะฑัะฐะฑะพัะบะฐ webhook:

```python
# app/webhooks/yookassa.py

async def yookassa_webhook(request):
    data = await request.json()
    
    if data['event'] == 'payment.succeeded':
        metadata = data['object']['metadata']
        
        if metadata['payment_type'] == 'subscription':
            # ะะบัะธะฒะธัะพะฒะฐัั ะฟะพะดะฟะธัะบั
            await billing.process_subscription_payment(
                user_id, tariff_name, payment_id
            )
            
        elif metadata['payment_type'] == 'topup':
            # ะะพะฟะพะปะฝะธัั ะผะพะฝะตัะบะธ
            await billing.process_topup_payment(
                user_id, coins, price_rub, bonus_coins
            )
```

## ๐ ะะฝะฐะปะธัะธะบะฐ

### ะะตััะธะบะธ ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั:

```python
# ะะถะตะดะฝะตะฒะฝะฐั ััะฐัะธััะธะบะฐ
- ะะพะฒัะต ะฟะพะดะฟะธัะบะธ: COUNT(subscriptions WHERE date = today)
- ะะพะฟะพะปะฝะตะฝะธั: COUNT(transactions WHERE type = 'topup')
- ะััััะบะฐ: SUM(amount) WHERE date = today

# ะะพะปัะทะพะฒะฐัะตะปััะบะฐั ะฐะบัะธะฒะฝะพััั
- ะะบัะธะฒะฝัะต ะฟะพะดะฟะธัะบะธ: COUNT(subscriptions WHERE is_active = true)
- ะกัะตะดะฝะธะน ะฑะฐะปะฐะฝั: AVG(users.videos_left)
- ะะพะฝะฒะตััะธั: ะฟะพะดะฟะธัะพะบ / ะฝะพะฒัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
```

## ๐ฏ ะกััะฐัะตะณะธั ะผะพะฝะตัะธะทะฐัะธะธ

### ะะพัะตะผั ะดะฒะต ัะธััะตะผั?

1. **ะะพะดะฟะธัะบะธ (ัะฐัะธัั)**
   - โ ะัะตะดัะบะฐะทัะตะผัะน ะดะพัะพะด
   - โ ะะพะปะณะพััะพัะฝัะต ะบะปะธะตะฝัั
   - โ ะะพะปะตะต ะฒัะณะพะดะฝะพ ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั (ะฑะพะปััะต ะผะพะฝะตัะพะบ)

2. **ะะพะฟะพะปะฝะตะฝะธั (ะผะพะฝะตัะบะธ)**
   - โ ะะธะทะบะธะน ะฟะพัะพะณ ะฒัะพะดะฐ
   - โ ะะธะฑะบะพััั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั
   - โ ะะพะฟะพะปะฝะธัะตะปัะฝัะน ะดะพัะพะด ะพั ะฐะบัะธะฒะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน

### Pricing ัััะฐัะตะณะธั:

```
ะะพะดะฟะธัะบะฐ "ะกัะฐะฝะดะฐัั": 400 ะผะพะฝะตั = 2990 โฝ โ 7.47 โฝ/ะผะพะฝะตัะบะฐ
ะะฐะบะตั 250 ะผะพะฝะตั: 280 ะผะพะฝะตั = 3990 โฝ โ 14.25 โฝ/ะผะพะฝะตัะบะฐ

ะะพะดะฟะธัะบะฐ ะฒัะณะพะดะฝะตะต ะฟะพััะธ ะฒ 2 ัะฐะทะฐ!
โ ะะพัะธะฒะฐัะธั ะฟะพะบัะฟะฐัั ะฟะพะดะฟะธัะบั
```

## ๐ TODO

- [ ] ะะพะฑะฐะฒะธัั ะฐะฒัะพะฟัะพะดะปะตะฝะธะต ะฟะพะดะฟะธัะบะธ
- [ ] ะะพะฑะฐะฒะธัั ะฟัะพะผะพะบะพะดั
- [ ] ะะพะฑะฐะฒะธัั ัะตัะตัะฐะปัะฝัั ะฟัะพะณัะฐะผะผั
- [ ] ะะพะฑะฐะฒะธัั ัะฟะตัะธะฐะปัะฝัะต ะฐะบัะธะธ (Black Friday ะธ ั.ะด.)
- [ ] ะะฝัะตะณัะฐัะธั ั ะดััะณะธะผะธ ะฟะปะฐััะถะฝัะผะธ ัะธััะตะผะฐะผะธ (Stripe ะดะปั ะผะตะถะดัะฝะฐัะพะดะฝัั)

## โ ะงัะพ ัะถะต ัะฐะฑะพัะฐะตั

โ ะขะฐัะธัั ะฝะฐ 30 ะดะฝะตะน (3 ััะพะฒะฝั)
โ ะะฐะบะตัั ะฟะพะฟะพะปะฝะตะฝะธั (4 ะฟะฐะบะตัะฐ ั ะฑะพะฝััะฐะผะธ)
โ YooKassa ะธะฝัะตะณัะฐัะธั
โ Webhook ะพะฑัะฐะฑะพัะบะฐ
โ ะะฐัะธัะปะตะฝะธะต ะผะพะฝะตัะพะบ
โ ะกะฟะธัะฐะฝะธะต ะผะพะฝะตัะพะบ ะทะฐ ััะฝะบัะธะธ
โ ะะพะทะฒัะฐั ะผะพะฝะตัะพะบ ะฟัะธ ะพัะธะฑะบะฐั
โ ะััะพัะธั ััะฐะฝะทะฐะบัะธะน
โ ะัะพะฒะตัะบะฐ ะฑะฐะปะฐะฝัะฐ ะฟะตัะตะด ะพะฟะตัะฐัะธะตะน

---

**ะกะธััะตะผะฐ ะพะฟะปะฐัั ะฟะพะปะฝะพัััั ะณะพัะพะฒะฐ ะธ ัะฐะฑะพัะฐะตั!** ๐ฐ

